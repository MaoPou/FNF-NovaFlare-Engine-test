name: UpdateVersion

on:
  workflow_dispatch:
    inputs:
      version_input:
        description: '输入格式为"版本名 版本号"，例如：1.2.0-Dev 2.7'
        required: true
        default: ''

jobs:
  update-versions:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Parse version input
        id: parse-version
        run: |
          input="${{ github.event.inputs.version_input }}"
          version_name=$(echo "$input" | awk '{print $1}')
          version_number=$(echo "$input" | awk '{print $2}')
          commit_sha=$(git rev-parse --short HEAD)
          version_number_with_commit="$version_number-$commit_sha"
          
          echo "Parsed version name: $version_name"
          echo "Parsed version number: $version_number"
          echo "Commit SHA: $commit_sha"
          echo "Version number with commit: $version_number_with_commit"
          
          echo "version_name=$version_name" >> $GITHUB_OUTPUT
          echo "version_number=$version_number" >> $GITHUB_OUTPUT
          echo "version_number_with_commit=$version_number_with_commit" >> $GITHUB_OUTPUT
          echo "commit_sha=$commit_sha" >> $GITHUB_OUTPUT

      - name: Update gitVersion.txt
        run: |
          echo "Updating gitVersion.txt..."
          echo "${{ steps.parse-version.outputs.version_name }}" > gitVersion.txt
          echo "${{ steps.parse-version.outputs.version_number_with_commit }}" >> gitVersion.txt
          echo "Updated gitVersion.txt content:"
          cat gitVersion.txt

      - name: Update Project.xml
        run: |
          echo "Updating Project.xml..."
          # 更新版本名
          sed -i "s/\(<app title=\"NovaFlare Engine\".* version=\"\)[^\"]*\(\"\)/\1${{ steps.parse-version.outputs.version_name }}\2/" Project.xml
          # 智能更新构建编号 (build-number)，加上commit ID
          if grep -q 'build-number="[^"]*"' Project.xml; then
            sed -i "s/\(<app title=\"NovaFlare Engine\".* build-number=\"\)[^\"]*\(\"\)/\1${{ steps.parse-version.outputs.version_number_with_commit }}\2/" Project.xml
            echo "Updated existing build-number attribute with commit ID"
          else
            sed -i "s/\(<app title=\"NovaFlare Engine\".* version=\"[^\"]*\"\)/\1 build-number=\"${{ steps.parse-version.outputs.version_number_with_commit }}\"/" Project.xml
            echo "Added build-number attribute with commit ID"
          fi
          echo "Updated Project.xml version and build-number attributes"

      - name: Update MainMenuState.hx
        run: |
          echo "Updating MainMenuState.hx..."
          sed -i "s/\(public static var novaFlareEngineVersion:String = '\)[^']*/\1${{ steps.parse-version.outputs.version_name }}/" source/states/MainMenuState.hx
          sed -i "s/\(public static var novaFlareEngineDataVersion:Float = \)[0-9.]*/\1${{ steps.parse-version.outputs.version_number }}/" source/states/MainMenuState.hx
          echo "Updated MainMenuState.hx version variables"

      - name: Commit all changes
        run: |
          git config --local user.email "actions@github.com"
          git config --local user.name "GitHub Actions"
          git add gitVersion.txt Project.xml source/states/MainMenuState.hx
          git commit -m "chore: Update versions to ${{ steps.parse-version.outputs.version_name }} ${{ steps.parse-version.outputs.version_number_with_commit }}"
          git push
